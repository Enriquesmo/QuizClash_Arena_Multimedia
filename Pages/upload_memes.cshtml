@page
@model QuizClash_Arena_Multimedia.Pages.upload_memesModel
@{
    ViewData["Title"] = "Subir Imágenes o Videos";
}

<h1 style="text-align: center;">Sube tus Imágenes o Videos</h1>

<div style="text-align: center;">
    <form id="uploadForm" enctype="multipart/form-data">
        <input type="hidden" name="numPlayers" value="@Model.NumPlayers" /> <!-- Campo oculto para el número de jugadores -->
        <input type="file" name="files" accept="image/*, video/*" multiple required /><br /><br />
        <button type="submit">Subir</button>
    </form>
</div>

<div id="uploadedMemes" style="text-align: center; margin-top: 20px;">
    <h2>Memes subidos:</h2>
    <ul id="memeList"></ul>
</div>

<script src="~/lib/signalr/signalr.js"></script>
<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/gameHub")
        .build();

    connection.start().catch(err => console.error(err.toString()));

    connection.on("MemeUploaded", function (playerName, memeUrl) {
        const memeList = document.getElementById("memeList");
        const listItem = document.createElement("li");
        listItem.textContent = `Jugador: ${playerName}, Meme: ${memeUrl}`;
        memeList.appendChild(listItem);
    });

    // Manejar el envío del formulario con AJAX
    document.getElementById("uploadForm").onsubmit = async (e) => {
        e.preventDefault(); // Evitar la recarga de la página
        const formData = new FormData(e.target);

        const response = await fetch("/upload_memes", {
            method: "POST",
            body: formData
        });

        const data = await response.json(); // Esperar la respuesta en formato JSON
        if (data.success) {
            const memeList = document.getElementById("memeList");
            const listItem = document.createElement("li");
            listItem.textContent = `Jugador: ${data.playerName}, Meme: ${data.memeUrl}`; // Usar los datos devueltos
            memeList.appendChild(listItem);
        } else {
            console.error("Error al subir el meme");
        }
    };
</script>
